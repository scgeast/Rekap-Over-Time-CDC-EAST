<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikasi Rekap Lembur</title>

  <!-- Chart.js & XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #3498db;
      --danger: #e74c3c;
      --success: #27ae60;
      --sidebar: #2c3e50;
      --text: #333;
      --bg: #f4f6f9;
      --sidebar-width: 250px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      min-height: 100vh;
      position: relative;
    }

    /* Sidebar */
    #sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar);
      color: white;
      padding: 18px 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: width .28s ease, padding .28s ease;
      position: relative;
      z-index: 100;
    }
    #sidebar.collapsed { width: 0; padding: 0; overflow: hidden; }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.06);}
    .sidebar-header h3 { font-size: 1rem; margin: 0; }
    .sidebar-menu { list-style: none; padding: 8px 0; margin: 0; display: block; }
    .sidebar-menu li { padding: 10px 12px; border-radius: 6px; cursor: pointer; display: flex; gap: 8px; align-items: center; }
    .sidebar-menu li:hover, .sidebar-menu li.active { background: rgba(255,255,255,0.06); }

    /* Toggle (selalu tampil, warna hitam) */
    .toggle-btn {
      position: fixed;
      top: 14px;
      left: 12px;
      z-index: 2000;
      width: 26px;
      height: 18px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 0;
      border: 0;
      background: none;
      cursor: pointer;
    }
    .toggle-btn span {
      display: block;
      width: 100%;
      height: 3px;
      border-radius: 2px;
      background: #000; /* hitam */
    }

    /* Main */
    .main { flex: 1; padding: 28px; overflow: auto; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 22px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); }

    /* Login box */
    #login-box { max-width: 420px; margin: 90px auto; padding: 22px; background: #fff; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.06);}
    #login-box h1 { text-align: center; margin-bottom: 12px; font-size: 1.05rem; }
    .form-group { margin-bottom: 10px; }
    label.small { display: block; font-size: 0.78rem; font-weight: 600; margin-bottom: 6px; }
    input, select, textarea, button {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #d7dbe0; font-size: 0.95rem;
    }
    button.primary { background: var(--primary); color: #fff; font-weight: 700; border: 0; cursor: pointer; }
    button.ghost { background: transparent; border: 1px solid #d7dbe0; color: var(--text); }

    .header-flex { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 12px; }
    #total-jam { background: #eef6ff; color: #15395b; padding: 8px 12px; border-radius: 8px; font-weight: 700; }

    /* Toast */
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 16px; border-radius: 10px; color: #fff; box-shadow: 0 8px 28px rgba(7,12,34,0.12); transform: translateY(-8px); opacity: 0; transition: all .28s ease; z-index: 9999; font-weight: 600; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: var(--success); }
    .toast.info    { background: var(--primary); }
    .toast.error   { background: var(--danger); }

    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 6px; font-size: 0.9rem; }
    th { background: #f0f2f5; }

    @media (max-width: 900px) {
      #login-box { margin: 40px 12px; }
      #sidebar { position: fixed; height: 100vh; left: 0; top: 0; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside id="sidebar" class="hidden">
    <div class="sidebar-header">
      <h3>üìÇ Menu</h3>
    </div>
    <ul class="sidebar-menu" id="sidebar-menu">
      <li data-tab="rekap" class="active">üìã Rekap Over Time</li>
      <li data-tab="master" class="admin-only">üìÅ Master</li>
      <div style="padding-left:12px;margin-top:6px;" class="admin-only">
        <div data-tab="master-output" style="padding:6px 0;cursor:pointer;">‚Üí Output Rekapan</div>
        <div data-tab="master-summary" style="padding:6px 0;cursor:pointer;">‚Üí Summary</div>
        <div data-tab="master-setting" style="padding:6px 0;cursor:pointer;">‚Üí Setting</div>
      </div>
    </ul>
    <div style="margin-top:auto;padding-top:10px;border-top:1px solid rgba(255,255,255,0.04);">
      <div style="font-size:0.95rem;margin-bottom:8px;">User: <strong id="user-display">-</strong></div>
      <button id="btn-logout" class="ghost">Logout</button>
    </div>
  </aside>

  <!-- Toggle (selalu tampil) -->
  <button id="toggle-btn" class="toggle-btn">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Main -->
  <main class="main">
    <div class="container" id="app-container">
      <!-- Login -->
      <section id="login-box">
        <h1>üîê Rekap Over Time CDC EAST</h1>
        <div class="form-group">
          <label class="small">Nama PIC / Admin</label>
          <select id="login-username">
            <option value="">-- Pilih Nama --</option>
            <option>Agung Setyawan</option>
            <option>Fahmi Ardiansyah</option>
            <option>Drajat Triono</option>
            <option>Wiyanto</option>
            <option>Nur Fauziah</option>
            <option value="admin">admin</option>
          </select>
        </div>
        <div class="form-group">
          <label class="small">Password</label>
          <input id="login-password" type="password" placeholder="Masukkan password">
        </div>
        <div style="display:flex;gap:10px;margin-top:8px;">
          <button id="btn-login" class="primary" style="flex:1;">Login</button>
          <button id="btn-clear" class="ghost" style="flex:0 0 86px;">Clear</button>
        </div>
        <p id="login-error" style="margin-top:10px;color:#c0392b;display:none;"></p>
      </section>

      <!-- App content -->
      <section id="app-placeholder" class="hidden">
        <div class="header-flex">
          <h2 id="page-title">üìù Input & Rekap Lembur - <span id="page-user">Nama</span></h2>
          <div id="total-jam">Total Jam: 0</div>
        </div>
        <div id="content-area"></div>
      </section>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    /* === Masukkan semua JavaScript panjang (Part 1‚Äì5) dari versi terakhir yang aku kasih === */
    /* Perbedaannya: hapus function positionToggle dan pemanggilannya */
    /* Karena toggle sudah fixed, jadi aman */

    // (tempelkan di sini JS Part 1‚Äì5 yang sudah aku rapikan sebelumnya)
  /* ================================
   Part 1 - Core (Login, Sidebar, Toast)
=================================== */

const SIDEBAR        = document.getElementById('sidebar');
const TOGGLE         = document.getElementById('toggle-btn');
const LOGIN_BOX      = document.getElementById('login-box');
const APP_PLACEHOLDER= document.getElementById('app-placeholder');
const USER_DISPLAY   = document.getElementById('user-display');
const LOGIN_USER     = document.getElementById('login-username');
const LOGIN_PASS     = document.getElementById('login-password');
const BTN_LOGIN      = document.getElementById('btn-login');
const BTN_CLEAR      = document.getElementById('btn-clear');
const BTN_LOGOUT     = document.getElementById('btn-logout');
const TOAST          = document.getElementById('toast');
const PAGE_USER      = document.getElementById('page-user');
const PAGE_TITLE     = document.getElementById('page-title');
const TOTAL_JAM_EL   = document.getElementById('total-jam');
const CONTENT        = document.getElementById('content-area');

const DEFAULT_USERS = {
  "Agung Setyawan"   : "12345",
  "Fahmi Ardiansyah" : "67890",
  "Drajat Triono"    : "45678",
  "Wiyanto"          : "23456",
  "Nur Fauziah"      : "54321",
  "admin"            : "123456789"
};

function initUserStore(){
  if(!localStorage.getItem('app_users')){
    localStorage.setItem('app_users', JSON.stringify(DEFAULT_USERS));
  }
}

/* === Toast Notification === */
let toastTimer = null;
function showToast(message, type = 'info', ms = 3000){
  TOAST.textContent = message;
  TOAST.className   = `toast ${type} show`;
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{
    TOAST.className = 'toast';
  }, ms);
}

/* === Toggle Position === */
function positionToggle(){
  const rect = SIDEBAR.getBoundingClientRect();
  let leftPos = rect.width < 10 ? 8 : rect.width - 14;
  TOGGLE.style.left = leftPos + 'px';
}

/* === Login & Logout === */
function showAppFor(user){
  USER_DISPLAY.textContent = user;
  PAGE_USER.textContent    = user;
  LOGIN_BOX.style.display  = 'none';
  SIDEBAR.classList.remove('hidden');
  APP_PLACEHOLDER.classList.remove('hidden');

  if(user === 'admin'){
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
  } else {
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
  }

  SIDEBAR.classList.remove('collapsed');
  positionToggle();
  showToast('Selamat datang, ' + user, 'success', 1600);

  // Default tab
  if(user === "admin"){
    renderAdmin();
  } else {
    renderPIC(user);
  }
}

function login(){
  const user = (LOGIN_USER.value || '').trim();
  const pass = (LOGIN_PASS.value || '').trim();

  if(!user || !pass){
    document.getElementById('login-error').style.display = 'block';
    document.getElementById('login-error').textContent   = 'Isi username & password.';
    return;
  }

  const users = JSON.parse(localStorage.getItem('app_users') || '{}');
  if(!users[user] || users[user] !== pass){
    document.getElementById('login-error').style.display = 'block';
    document.getElementById('login-error').textContent   = 'Username / password salah.';
    showToast('Login gagal', 'error');
    return;
  }

  localStorage.setItem('logged_in_user', user);
  document.getElementById('login-error').style.display = 'none';
  showAppFor(user);
}

function logout(){
  localStorage.removeItem('logged_in_user');
  location.reload();
}

/* === Event Binding === */
document.addEventListener('DOMContentLoaded', ()=>{
  initUserStore();
  SIDEBAR.classList.add('hidden');
  setTimeout(positionToggle, 80);

  const logged = localStorage.getItem('logged_in_user');
  if(logged) showAppFor(logged);

  TOGGLE.addEventListener('click', e=>{
    e.stopPropagation();
    SIDEBAR.classList.toggle('collapsed');
    setTimeout(positionToggle, 60);
  });

  window.addEventListener('resize', ()=> setTimeout(positionToggle, 120));

  BTN_LOGIN.addEventListener('click', login);
  BTN_CLEAR.addEventListener('click', ()=>{
    LOGIN_USER.value = '';
    LOGIN_PASS.value = '';
    document.getElementById('login-error').style.display = 'none';
  });
  BTN_LOGOUT.addEventListener('click', logout);

  document.getElementById('sidebar-menu').addEventListener('click', ev=>{
    const tab = ev.target.getAttribute('data-tab');
    if(!tab) return;
    document.querySelectorAll('#sidebar-menu li').forEach(i=>i.classList.remove('active'));
    if(ev.target.tagName.toLowerCase()==="li"){
      ev.target.classList.add('active');
    }

    const user = localStorage.getItem('logged_in_user');
    if(tab === 'rekap'){
      if(user === 'admin') renderAdmin(); else renderPIC(user);
    }
    if(tab === 'master-output') renderMasterOutput();
    if(tab === 'master-summary') renderMasterSummary();
    if(tab === 'master-setting') renderMasterSetting();
  });
});

/* Expose Core */
window.appCore = { showToast, positionToggle, SIDEBAR, APP_PLACEHOLDER, TOTAL_JAM_EL };

/* ================================
   Part 2 - PIC Input & Rekap
=================================== */
function renderPIC(user){
  CONTENT.innerHTML = `
    <div id="pic-form">
      <div class="form-group">
        <label class="small">Tanggal</label>
        <input type="date" id="pic-tanggal">
      </div>
      <div class="form-group">
        <label class="small">Jam Mulai</label>
        <input type="time" id="pic-jamMulai">
      </div>
      <div class="form-group">
        <label class="small">Jam Selesai</label>
        <input type="time" id="pic-jamSelesai">
      </div>
      <div class="form-group">
        <label class="small">Total Plant</label>
        <input type="number" id="pic-totalPlant" min="1" value="1">
      </div>
      <div class="form-group" id="pic-plant-container">
        <input type="text" placeholder="Plant Name 1" class="plant-input">
      </div>
      <div class="form-group">
        <label class="small">Uraian Lembur</label>
        <textarea id="pic-uraian" rows="2"></textarea>
      </div>
      <button id="btn-pic-save" class="primary">Simpan Data</button>
    </div>

    <div style="margin-top:20px;">
      <h3>üìã Rekap Data</h3>
      <table>
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Jam</th>
            <th>Plant</th>
            <th>Uraian</th>
            <th>Total Jam</th>
          </tr>
        </thead>
        <tbody id="pic-tbody"></tbody>
      </table>
      <button id="btn-pic-export" style="margin-top:12px;">Export Excel</button>
    </div>
  `;

  const totalPlantInput = document.getElementById("pic-totalPlant");
  const plantContainer  = document.getElementById("pic-plant-container");

  totalPlantInput.addEventListener("input",()=>{
    plantContainer.innerHTML = "";
    let total = parseInt(totalPlantInput.value)||0;
    for(let i=1;i<=total;i++){
      const inp = document.createElement("input");
      inp.type        = "text";
      inp.placeholder = "Plant Name " + i;
      inp.classList.add("plant-input");
      plantContainer.appendChild(inp);
    }
  });

  document.getElementById("btn-pic-save").addEventListener("click",()=>{
    const tgl       = document.getElementById("pic-tanggal").value;
    const jamMulai  = document.getElementById("pic-jamMulai").value;
    const jamSelesai= document.getElementById("pic-jamSelesai").value;
    const uraian    = document.getElementById("pic-uraian").value;
    const plants    = [...plantContainer.querySelectorAll("input")].map(i=>i.value).filter(v=>v);

    if(!tgl || !jamMulai || !jamSelesai || plants.length===0){
      appCore.showToast("Lengkapi data dulu","error"); return;
    }

    const [h1,m1] = jamMulai.split(":").map(Number);
    const [h2,m2] = jamSelesai.split(":").map(Number);
    let totalJam  = (h2*60+m2) - (h1*60+m1);
    if(totalJam<0) totalJam += 24*60;
    totalJam = (totalJam/60).toFixed(2);

    const entry = {tgl,jamMulai,jamSelesai,plants,uraian,totalJam};

    let data = JSON.parse(localStorage.getItem("data_"+user)||"[]");
    data.push(entry);
    localStorage.setItem("data_"+user, JSON.stringify(data));

    appCore.showToast("Data berhasil disimpan","success");
    renderPICTable(user);
  });

  document.getElementById("btn-pic-export").addEventListener("click",()=>{
    let data = JSON.parse(localStorage.getItem("data_"+user)||"[]");
    if(data.length===0){ appCore.showToast("Tidak ada data","error"); return; }

    const ws_data = [["Tanggal","Jam","Plant","Uraian","Total Jam"]];
    data.forEach(d=>{
      ws_data.push([d.tgl, d.jamMulai+"-"+d.jamSelesai, d.plants.join(", "), d.uraian, d.totalJam]);
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Rekap");
    XLSX.writeFile(wb, "Rekap_"+user+".xlsx");
  });

  renderPICTable(user);
}

function renderPICTable(user){
  let data = JSON.parse(localStorage.getItem("data_"+user)||"[]");
  const tb = document.getElementById("pic-tbody");
  tb.innerHTML = "";
  let totalJamSum = 0;

  data.forEach(d=>{
    totalJamSum += parseFloat(d.totalJam);
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.tgl}</td>
      <td>${d.jamMulai} - ${d.jamSelesai}</td>
      <td>${d.plants.join(", ")}</td>
      <td>${d.uraian||""}</td>
      <td>${d.totalJam}</td>
    `;
    tb.appendChild(tr);
  });

  appCore.TOTAL_JAM_EL.textContent = "Total Jam: " + totalJamSum.toFixed(2);
}

/* ================================
   Part 3 - Admin Monitoring
=================================== */
function renderAdmin(){
  CONTENT.innerHTML = `
    <h2>üìä Monitoring Rekap Semua User</h2>
    <table>
      <thead>
        <tr>
          <th>User</th>
          <th>Tanggal</th>
          <th>Jam</th>
          <th>Plant</th>
          <th>Uraian</th>
          <th>Total Jam</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="admin-tbody"></tbody>
    </table>
  `;
  renderAdminTable();
}

function renderAdminTable(){
  const tb = document.getElementById("admin-tbody");
  tb.innerHTML = "";

  Object.keys(localStorage).forEach(k=>{
    if(!k.startsWith("data_")) return;
    const user = k.replace("data_","");
    let data   = JSON.parse(localStorage.getItem(k)||"[]");
    data.forEach((d,idx)=>{
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${user}</td>
        <td>${d.tgl}</td>
        <td>${d.jamMulai} - ${d.jamSelesai}</td>
        <td>${d.plants.join(", ")}</td>
        <td>${d.uraian||""}</td>
        <td>${d.totalJam}</td>
        <td>
          <button onclick="editAdmin('${user}',${idx})">‚úèÔ∏è</button>
          <button onclick="deleteAdmin('${user}',${idx})">üóëÔ∏è</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  });
}

function editAdmin(user, idx){
  const data = JSON.parse(localStorage.getItem("data_"+user)||"[]");
  const d    = data[idx];
  const newUraian = prompt("Edit uraian lembur:", d.uraian||"");
  if(newUraian===null) return;
  d.uraian = newUraian;
  data[idx]= d;
  localStorage.setItem("data_"+user, JSON.stringify(data));
  appCore.showToast("Data berhasil diperbarui","info");
  renderAdminTable();
}

function deleteAdmin(user, idx){
  if(!confirm("Hapus data ini?")) return;
  let data = JSON.parse(localStorage.getItem("data_"+user)||"[]");
  data.splice(idx,1);
  localStorage.setItem("data_"+user", JSON.stringify(data));
  appCore.showToast("Data berhasil dihapus","error");
  renderAdminTable();
}

/* ================================
   Part 4 - Master Output & Summary
=================================== */
function renderMasterOutput(){
  CONTENT.innerHTML = `
    <h2>üìÅ Master Output</h2>
    <button id="btn-export-all">Export Semua Data ke Excel</button>
  `;

  document.getElementById("btn-export-all").addEventListener("click",()=>{
    const ws_data = [["User","Tanggal","Jam","Plant","Uraian","Total Jam"]];
    Object.keys(localStorage).forEach(k=>{
      if(!k.startsWith("data_")) return;
      const user = k.replace("data_","");
      let data   = JSON.parse(localStorage.getItem(k)||"[]");
      data.forEach(d=>{
        ws_data.push([user, d.tgl, d.jamMulai+"-"+d.jamSelesai, d.plants.join(", "), d.uraian||"", d.totalJam]);
      });
    });
    if(ws_data.length===1){ appCore.showToast("Tidak ada data","error"); return; }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Semua Data");
    XLSX.writeFile(wb, "Master_Output.xlsx");
    appCore.showToast("Export berhasil","success");
  });
}

function renderMasterSummary(){
  CONTENT.innerHTML = `
    <h2>üìä Summary Lembur per User</h2>
    <canvas id="summary-chart" height="100"></canvas>
  `;

  const ctx = document.getElementById("summary-chart").getContext("2d");
  let labels=[],totals=[];
  Object.keys(localStorage).forEach(k=>{
    if(!k.startsWith("data_")) return;
    const user = k.replace("data_","");
    let data   = JSON.parse(localStorage.getItem(k)||"[]");
    let sum    = data.reduce((acc,d)=>acc+parseFloat(d.totalJam||0),0);
    labels.push(user);
    totals.push(sum.toFixed(2));
  });

  new Chart(ctx,{
    type:"bar",
    data:{
      labels:labels,
      datasets:[{label:"Total Jam",data:totals,backgroundColor:"#3498db"}]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:true}}
    }
  });
}

/* ================================
   Part 5 - Setting User
=================================== */
function renderMasterSetting(){
  CONTENT.innerHTML = `
    <h2>‚öôÔ∏è Setting User</h2>
    <div style="margin-bottom:14px;">
      <input type="text" id="new-username" placeholder="Username baru" style="margin-right:6px;">
      <input type="text" id="new-password" placeholder="Password" style="margin-right:6px;">
      <button id="btn-add-user">Tambah User</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Username</th>
          <th>Password</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="setting-tbody"></tbody>
    </table>
  `;

  renderUserTable();
  document.getElementById("btn-add-user").addEventListener("click",()=>{
    const uname = document.getElementById("new-username").value.trim();
    const pass  = document.getElementById("new-password").value.trim();
    if(!uname || !pass){ appCore.showToast("Isi username & password","error"); return; }
    let users = JSON.parse(localStorage.getItem("app_users")||"{}");
    if(users[uname]){ appCore.showToast("User sudah ada","error"); return; }
    users[uname] = pass;
    localStorage.setItem("app_users", JSON.stringify(users));
    appCore.showToast("User ditambahkan","success");
    renderUserTable();
  });
}

function renderUserTable(){
  let users = JSON.parse(localStorage.getItem("app_users")||"{}");
  const tb  = document.getElementById("setting-tbody");
  tb.innerHTML = "";
  Object.keys(users).forEach(u=>{
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u}</td>
      <td>${users[u]}</td>
      <td>
        <button onclick="editUser('${u}')">‚úèÔ∏è</button>
        <button onclick="deleteUser('${u}')">üóëÔ∏è</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

function editUser(user){
  let users  = JSON.parse(localStorage.getItem("app_users")||"{}");
  const newP = prompt("Password baru untuk "+user, users[user]);
  if(newP===null) return;
  users[user] = newP;
  localStorage.setItem("app_users", JSON.stringify(users));
  appCore.showToast("Password diperbarui","info");
  renderUserTable();
}

function deleteUser(user){
  if(!confirm("Hapus user "+user+"?")) return;
  let users = JSON.parse(localStorage.getItem("app_users")||"{}");
  delete users[user];
  localStorage.setItem("app_users", JSON.stringify(users));
  appCore.showToast("User dihapus","error");
  renderUserTable();
}

</script>
</body>
</html>
